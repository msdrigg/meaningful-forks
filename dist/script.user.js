// ==UserScript==
// @name         meaningful-forks
// @homepage     https://github.com/aflowofcode/meaningful-forks
// @namespace    http://tampermonkey.net/
// @version      0.3
// @description  Sort Github fork lists by the number of stars and commits ahead from the source repo.
// @author       Kevin Li + community
// @match        https://github.com/*/network/members
// @grant        none
// ==/UserScript==
!async function(){const e="<YOUR ACCESS TOKEN>";let t=new Headers;t.append("Authorization","token "+e);const r={headers:t},n=document.createElement("span");function o(t){return t.indexOf("?")<0?`${t}?access_token=${e}`:`${t}&access_token=${e}`}n.innerText="Sorting ðŸ´forks...",n.style.position="fixed",n.style.background="#22f922",n.style.padding="10px",n.style.borderRadius="10px",n.style.zIndex="9999",n.style.left="calc(50% - 60px)",n.style.top="calc(50% - 20px)",document.body.appendChild(n);const a=document.querySelector("#network"),s=a.querySelector("span.current-repository").lastElementChild.getAttribute("href").substring(1);console.log("TCL: currentRepoUrl",s);const i=s.substring(0,s.lastIndexOf("/")),c=o(`https://api.github.com/repos/${s}/forks?sort=stargazers`);console.log("TCL: forkApiUrl",c);let l=await fetch(c,r);const d=await l.json();d.forEach(e=>{console.log(e.full_name+", ")}),console.log("TCL: forks.length: "+d.length);const u=[];var h,p,f,g;async function m(e,t){let n,o=await fetch(e,r);if(!o.ok)throw new Error("Network response is not OK!");if(n=await o.json(),"string"==typeof t)return a(n,t);if(Array.isArray(t))return t.map(e=>a(n,e));function a(e,t){if(t.indexOf(".")>=0){let r=e;return t.split(".").forEach(e=>{r=r[e]}),r}return e[t]}}async function b(e){return m(o(`https://api.github.com/repos/${e}`),"default_branch")}function y(e){const t="http://www.w3.org/2000/svg";var r=document.createElementNS(t,"svg");r.setAttribute("height",12),r.setAttribute("width",10.5),r.setAttribute("viewBox","0 0 14 16"),r.style["vertical-align"]="middle",r.style.fill="currentColor",r.style.position="relative",r.style.bottom="1px",r.classList.add("opticon","opticon-"+e);var n=document.createElementNS(t,"title"),o=document.createElementNS(t,"path");switch(e){case"star":n.appendChild(document.createTextNode("Number of real stars (excluding author's star)")),o.setAttribute("d","M14 6l-4.9-0.64L7 1 4.9 5.36 0 6l3.6 3.26L2.67 14l4.33-2.33 4.33 2.33L10.4 9.26 14 6z"),o.setAttribute("fill","black");break;case"up":n.appendChild(document.createTextNode("Number of commits ahead")),o.setAttribute("d","M5 3L0 9h3v4h4V9h3L5 3z"),o.setAttribute("fill","#84ed47"),r.setAttribute("viewBox","0 0 10 16"),r.setAttribute("height",16);break;case"flame":n.appendChild(document.createTextNode("Fork may be more recent than upstream.")),o.setAttribute("d","M5.05 0.31c0.81 2.17 0.41 3.38-0.52 4.31-0.98 1.05-2.55 1.83-3.63 3.36-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-0.3-6.61-0.61 2.03 0.53 3.33 1.94 2.86 1.39-0.47 2.3 0.53 2.27 1.67-0.02 0.78-0.31 1.44-1.13 1.81 3.42-0.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52 0.13-2.03 1.13-1.89 2.75 0.09 1.08-1.02 1.8-1.86 1.33-0.67-0.41-0.66-1.19-0.06-1.78 1.25-1.23 1.75-4.09-1.88-6.22l-0.02-0.02z"),o.setAttribute("fill","#d26911")}return o.appendChild(n),r.appendChild(o),r}d.forEach((e,t,n)=>{const a=e.owner.login;console.log("TCL: authorName",a);const s=o(e.stargazers_url);u.push(fetch(s,r).then(e=>{if(e.ok)return e.json();throw new Error("Network response is not OK!")}).then(e=>{e.forEach(e=>{e.login===a&&n[t].stargazers_count>0&&(console.log(`TCL: starCount of ${a} before: ${n[t].stargazers_count}`),n[t].stargazers_count--,console.log(`TCL: starCount of ${a} after: ${n[t].stargazers_count}`))})}).catch(function(e){console.log("There has been a problem with your fetch operation: ",e.message)}))}),await Promise.all(u),d.sort((h="stargazers_count",p=!0,f=parseInt,g=f?function(e){return f(e[h])}:function(e){return e[h]},p=p?-1:1,function(e,t){return e=g(e),t=g(t),p*((e>t)-(t>e))})),console.log("End of modifying stargazer count!"),await async function(e,t){const r=[];for(let n=0;n<e.length;n++)r.push(t(e[n],n,e));return Promise.all(r)}(d,async(e,t,r)=>{try{const n=e.owner.login,a=e.full_name;let c=await b(s),l=await b(a);const d=o(`https://api.github.com/repos/${a}/compare/${i}:${c}...${n}:${l}`);let[u,h]=await m(d,["ahead_by","behind_by"]);r[t].ahead_by=u,r[t].behind_by=h}catch(e){console.log(e)}}),console.log("TCL: forks",d),d.sort(function(){var e=[].slice.call(arguments),t=e.length;return function(r,n){var o,a,s,i,c,l,d;for(d=0;d<t&&(l=0,s=e[d],i="string"==typeof s?s:s.name,o=r[i],a=n[i],void 0!==s.primer&&(o=s.primer(o),a=s.primer(a)),c=s.highToLow?-1:1,o<a&&(l=-1*c),o>a&&(l=1*c),0===l);d++);return l}}({name:"stargazers_count",primer:parseInt,highToLow:!0},{name:"ahead_by",primer:parseInt,highToLow:!0},{name:"behind_by",primer:parseInt,highToLow:!1})),console.log("Beginning of DOM operations!"),d.reverse().forEach(e=>{const t=e.full_name,r=e.stargazers_count;let o=!1;if(a.querySelectorAll("div.repo").forEach(e=>{const r=e.lastElementChild.getAttribute("href");if(r){r.substring(1)===t&&(o=!0,s(e))}}),!o){const r=document.createElement("div");r.classList.add("repo");const n=document.createElement("img");n.alt="",n.classList.add("network-tree"),n.src="https://github.githubassets.com/images/modules/network/t.png";const o=e.owner.type.toLowerCase(),a=document.createElement("a");a.setAttribute("data-hovercard-type",o);const i=e.owner.login;if("user"===o){const t=e.owner.id;a.setAttribute("data-hovercard-url",`/hovercards?user_id=${t}`)}else"organization"===o&&(a.setAttribute("data-hovercard-url",`/orgs/${i}/hovercard`),a.setAttribute("href",`/${i}`));a.setAttribute("href",`/${i}`),a.setAttribute("data-octo-click","hovercard-link-click"),a.setAttribute("data-octo-dimensions","link_type:self");const c=a.cloneNode(!0);c.style.paddingLeft="4px",c.style.paddingRight="4px",a.innerText=i,c.classList.add("d-inline-block");const l=document.createElement("img");l.classList.add("gravatar");const d=e.owner.avatar_url;l.src=d,l.width="16",l.height="16",l.alt=`@${i}`,c.appendChild(l);const u=document.createElement("a");u.style.paddingRight="4px",u.setAttribute("href",`/${t}`),u.innerText=e.name,r.appendChild(n),r.appendChild(c),r.appendChild(a),r.appendChild(document.createTextNode(" / ")),r.appendChild(u),s(r)}function s(t){const n=document.createDocumentFragment();if(n.appendChild(y("star")),n.appendChild(document.createTextNode(r+" ")),e.ahead_by>0){const t=y("up");n.appendChild(t),n.appendChild(document.createTextNode(e.ahead_by+" "))}e.ahead_by-e.behind_by>0&&n.appendChild(y("flame")),t.appendChild(n),a.firstElementChild.insertAdjacentElement("afterend",t)}n.remove(),console.log("TCL: starCount",e.stargazers_count)})}();